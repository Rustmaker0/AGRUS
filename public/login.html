<!doctype html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Вход / Регистрация — АГРУС</title>
  <link rel="stylesheet" href="/styles.css"/>
</head>
<body id="page-login">
  <main class="container" style="max-width:720px">
    <div class="card">
      <div class="card-title">
        <h1 id="authTitle">Вход</h1>
        <button id="toggleMode" class="btn-secondary" type="button">Регистрация</button>
      </div>

      <!-- Форма входа -->
      <form id="loginForm" class="form" novalidate autocomplete="on">
        <div>
          <label for="loginEmail">Email</label>
          <input id="loginEmail" type="email" placeholder="you@example.com" />
          <div id="loginEmailError" class="error"></div>
        </div>
        <div>
          <label for="loginPassword">Пароль</label>
          <input id="loginPassword" type="password" minlength="4" placeholder="••••" />
          <div id="loginPasswordError" class="error"></div>
        </div>
        <div class="row" style="justify-content: flex-end">
          <button id="loginButton" class="btn" type="submit">Войти</button>
        </div>
      </form>

      <!-- Форма регистрации -->
      <form id="registerForm" class="form hidden" novalidate autocomplete="off">
        <div class="row">
          <div style="flex:1">
            <label for="regName">Имя</label>
            <input id="regName" type="text" placeholder="Иван"/>
          </div>
          <div style="flex:1">
            <label for="regRole">Роль</label>
            <select id="regRole">
              <option value="">— выберите роль —</option>
              <option value="client">Клиент</option>
              <option value="master">Мастер</option>
            </select>
            <div id="regRoleError" class="error"></div>
          </div>
        </div>

        <div>
          <label for="regEmail">Email</label>
          <input id="regEmail" type="email" placeholder="you@example.com" />
          <div id="regEmailError" class="error"></div>
        </div>

        <div class="row">
          <div style="flex:1">
            <label for="regPassword">Пароль</label>
            <input id="regPassword" type="password" minlength="4" placeholder="••••" />
          </div>
          <div style="flex:1">
            <label for="regPassword2">Повтор пароля</label>
            <input id="regPassword2" type="password" minlength="4" placeholder="••••" />
            <div id="regPassword2Error" class="error"></div>
          </div>
        </div>

        <div class="row" style="justify-content: flex-end">
          <button id="registerButton" class="btn" type="submit">Зарегистрироваться</button>
        </div>
      </form>

      <p class="help" id="authHelp" style="margin-top:8px">Нет аккаунта? Нажмите «Регистрация».</p>
    </div>
  </main>

  <script src="/app.js"></script>
  <script>
    const q  = (s)=>document.querySelector(s), qa=(s)=>document.querySelectorAll(s);
    function isEmail(str, el){
      if(!str) return false;
      const v = String(str).trim().toLowerCase().replace(/\s+/g, "");
      const soft = /^[^@\s]+@[^@\s]+\.[^@\s]+$/i.test(v);
      if(soft) return true;
      try { if (el && typeof el.checkValidity === "function") return el.checkValidity(); } catch(_) {}
      return false;
    }

    const $login    = q("#loginForm");
    const $register = q("#registerForm");
    const $title    = q("#authTitle");
    const $toggle   = q("#toggleMode");
    const $help     = q("#authHelp");

    function setMode(mode){
      const isLogin = mode === "login";
      $login.classList.toggle("hidden", !isLogin);
      $register.classList.toggle("hidden", isLogin);
      $title.textContent = isLogin ? "Вход" : "Регистрация";
      $toggle.textContent = isLogin ? "Регистрация" : "Вход";
      $help.textContent = isLogin ? "Нет аккаунта? Нажмите «Регистрация»." : "Есть аккаунт? Нажмите «Вход».";
      qa(".error").forEach(el=> el.textContent = "");
      history.replaceState(null, "", isLogin ? "?mode=login" : "?mode=register");
    }
    const url = new URL(location.href);
    setMode(url.searchParams.get("mode") === "register" ? "register" : "login");
    $toggle.addEventListener("click", ()=>{
      const nowLogin = !$login.classList.contains("hidden");
      setMode(nowLogin ? "register" : "login");
    });

    function showLoginHints(){
      const el = q("#loginEmail");
      const ok = isEmail(el.value, el);
      q("#loginEmailError").textContent = ok ? "" : "Некорректный email";
      q("#loginPasswordError").textContent = (q("#loginPassword").value.trim().length >= 4) ? "" : "Минимум 4 символа";
    }
    function showRegisterHints(){
      const el = q("#regEmail");
      const ok = isEmail(el.value, el);
      const p1 = q("#regPassword").value.trim();
      const p2 = q("#regPassword2").value.trim();
      const role = q("#regRole").value;
      q("#regEmailError").textContent    = ok ? "" : "Некорректный email";
      q("#regPassword2Error").textContent= (p1 && p2 && p1===p2) ? "" : "Пароли должны совпадать";
      q("#regRoleError").textContent     = role ? "" : "Выберите роль";
    }
    qa("#loginEmail, #loginPassword").forEach(el => el.addEventListener("input", showLoginHints));
    qa("#regEmail, #regPassword, #regPassword2, #regRole").forEach(el => el.addEventListener("input", showRegisterHints));

    // submit: вход
    $login.addEventListener("submit", async (e)=>{
      e.preventDefault(); showLoginHints();
      const emailEl = q("#loginEmail");
      const email = String(emailEl.value||"").trim().toLowerCase();
      const pass  = q("#loginPassword").value.trim();
      if(!isEmail(email, emailEl) || pass.length < 4) return;
      try{
        const { token, user } = await API.login(email, pass);
        setToken(token);
        location.href = user.role === "master" ? "/master.html" : "/client.html";  /* <-- ЛК клиента */
      }catch{ q("#loginEmailError").textContent = "Неверный email или пароль"; }
    });

    // submit: регистрация
    $register.addEventListener("submit", async (e)=>{
      e.preventDefault(); showRegisterHints();
      const emailEl = q("#regEmail");
      const name  = q("#regName").value.trim();
      const email = String(emailEl.value||"").trim().toLowerCase();
      const p1    = q("#regPassword").value.trim();
      const p2    = q("#regPassword2").value.trim();
      const role  = q("#regRole").value;
      const valid = isEmail(email, emailEl) && p1.length>=4 && p1===p2 && !!role;
      if(!valid) return;
      try{
        const { token, user } = await API.register({ name, email, password: p1, role });
        setToken(token);
        location.href = user.role === "master" ? "/master.html" : "/client.html";  /* <-- ЛК клиента */
      }catch(err){
        if(err?.details?.error === "EMAIL_EXISTS") q("#regEmailError").textContent="Почта уже зарегистрирована";
        else q("#regEmailError").textContent = "Ошибка регистрации";
      }
    });
  </script>
</body>
</html>
